<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Poliçe Ekle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card { border:0; box-shadow:0 10px 30px rgba(0,0,0,.06); }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">Staj CRM</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/customers">Müşteri Listesi</a>
    </div>
  </div>
</nav>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-7">
      <div class="card p-4">
        <h3 class="mb-3">Yeni Poliçe Ekle</h3>

        <form action="/policies" method="post" class="row g-3">

          <!-- Poliçe No -->
          <div class="col-md-6">
            <label class="form-label">Poliçe No</label>
            <input type="text" name="policyNumber" class="form-control" required>
          </div>

          <!-- Başlangıç / Bitiş -->
          <div class="col-md-3">
            <label class="form-label">Başlangıç</label>
            <input type="date" name="startDate" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Bitiş</label>
            <input type="date" name="endDate" class="form-control" required>
          </div>

          <!-- Müşteri -->
          <div class="col-md-6">
            <label class="form-label">Müşteri</label>
            <select id="customerSelect" name="customerId" class="form-select" required>
              <option value="" selected disabled>Seçin…</option>
              <option th:each="c : ${customers}"
                      th:value="${c.id}"
                      th:text="${c.name} + ' (' + ${c.email} + ')'">
              </option>
            </select>
          </div>

          <!-- Araba (müşteriye göre filtrelenir) -->
          <div class="col-md-6">
            <label class="form-label">Araba</label>
            <select id="carSelect" name="carId" class="form-select" required>
              <option value="" selected disabled>Önce müşteri seçin…</option>
              <!-- tüm arabaları dolduruyoruz, JS müşteri id’sine göre filtreleyecek -->
              <option th:each="car : ${cars}"
                      th:value="${car.id}"
                      th:text="${car.plate} + ' - ' + ${car.brand} + ' ' + ${car.model}"
                      th:attr="data-customer-id=${car.customer.id}">
              </option>
            </select>
          </div>

          <!-- Aktif mi -->
          <div class="col-12 form-check ms-2">
            <input class="form-check-input" type="checkbox" id="activeCheck" name="active" checked>
            <label class="form-check-label" for="activeCheck">Aktif</label>
          </div>

          <!-- CSRF (Spring Security varsa) -->
          <input type="hidden" th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div class="col-12 d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-primary">Kaydet</button>
            <a href="/" class="btn btn-outline-secondary">İptal</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // müşteri değişince araba listesini filtrele
  const customerSelect = document.getElementById('customerSelect');
  const carSelect = document.getElementById('carSelect');

  function filterCars() {
    const cid = customerSelect.value;
    const options = [...carSelect.querySelectorAll('option')];

    // ilk placeholder dışındaki seçenekleri gizle/göster
    options.forEach((opt, idx) => {
      if (idx === 0) return; // placeholder
      const owner = opt.getAttribute('data-customer-id');
      opt.style.display = (cid && owner === cid) ? '' : 'none';
    });

    // seçimi sıfırla
    carSelect.value = '';
  }

  customerSelect?.addEventListener('change', filterCars);
  // sayfa ilk açıldığında da uygula (geri dönüşlerde işe yarar)
  filterCars();
</script>

<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
